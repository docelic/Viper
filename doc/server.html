<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Viper - Fully Automated Debian GNU Installation, Configuration and Monitoring</title>
	<link rel="stylesheet" href="style.css" type="text/css" charset="utf-8">
</head>
<body>
<div id="wrapper">
	<div id="body">
		<div id="body-top">
			<div id="body-top-2"></div>
			<div id="body-bot">
				<div id="welcome">
					<h1>&clubs;</h1>
					<h2>VIPER</h2>
<ul>
  <li><a href="index.html">Index page</a></li>
</ul>
					<h2>Quick Start</h2>
<ul>
  <li><a href="server.html">Setting up Viper server</a><br>
  <li><a href="openvz.html">Viper in OpenVZ container</a><br>
  </li>
</ul>
<h2>Guides</h2>
<ul>
  <li><a href="client.html">Adding clients and hosts</a><br>
  <li><a href="values.html">Adding configuration values</a><br><br>
  <li><a href="configuration.html">Configuration file reference</a><br>
  <li><a href="viper.html">Viper syntax reference</a><br>
</ul>
<h2>Overviews<br>
</h2>
<ul>
  <li><a href="components.html">Host installation procedure </a></li>
  <li><a href="ldap.html">Viper OpenLDAP backend</a></li>
  <li><a href="data.html">Viper LDAP data structure</a></li>
</ul>
<h2>Misc info</h2>
<ul>
  <li><a href="hints.html">Hints &amp; tips</a><br>
  <li><a href="users.html">Viper installations</a><br>
</ul>
<h2>Resources</h2>
<ul>
  <li><a href="http://github.com/docelic/Viper/">Viper @ GitHub</a> </li>
  <li>IRC.OFTC.NET, #viper</li>
  <li><a href="https://lists.hcoop.net/listinfo/viper-users">Mailing list</a></li>
  <li><a href="support.html">Commercial support</a></li>
</ul>
				</div>
				<div id="content">
<h1>Viper - Setting up an installation server</h1>
<p>
Here's a guide to setting up a completely functional Viper
server, on a system running Debian GNU or Ubuntu.
</p>
<p>
The procedure can be followed both standalone on a physical machine, or
inside the OpenVZ container (for openvz, see
<a href="openvz.html">Viper in OpenVZ container</a> first).
</p>
<h2>Download</h2>
<p>
The easiest way to download the files is to clone them from the Git
repository and place in <i>/etc/ldap/viper/</i>.
<pre>
apt-get install git-core

mkdir -p /etc/ldap
cd /etc/ldap
git clone git://github.com/docelic/Viper.git viper
cd viper
</pre>
</p>
<h2>Main setup (Viper/LDAP + DHCP)</h2>
<p>
To set things up after download, you will use script <a
 href="../scripts/viper-setup.sh">scripts/viper-setup.sh</a>.
<br>
The purpose of the script is to get Viper up and
running quickly, with the default config.
The default config is quite independent and can be ran on probably every
machine that does not already run a LDAP and DHCP server.
After the system is running, you will have a clean and known-good base to
start creating your own configuration.<br>
<br>
Before running the script, you should do just one thing, related to the
DHCP server -- you should create a network interface with IP address 10.0.1.1,
to fit in the example subnet used by our default config. Then, you can run
the install script with the name of the physical interface.
</p>
<p>
Here's the session transcript that uses device eth1. This is a practical
scenario on a host with two network interfaces: eth0 that uses DHCP and hooks
to whatever the host's parent network and gateway to the Internet is, and
eth1 that is intended for Viper and that hooks into a separate switch or
client hosts directly.
</p>
<p>
(If you've set up Viper in the VZ container, chances are you already
configured eth0 and eth1, so you do not need to run ifconfig or
modify /etc/network/interfaces as shown here; proceed to running the script).
</p>
<pre>
ifconfig eth1 inet 10.0.1.1 netmask 255.255.255.0
invoke-rc.d ipmasq restart # (If you have it installed)
</pre>
<p>
To configure eth1 on every boot, add it to <i>/etc/network/interfaces</i>
with a stanza like this:
</p>
<pre>
allow-hotplug eth1
iface eth1 inet static
	address 10.0.1.1
	netmask 255.255.255.0
</pre>
<p>
To run the script, use:
</p>
<pre>
sh scripts/viper-setup.sh eth1
</pre>
<p>
Eth1 should be the name of the physical interface on which address 10.0.1.1
was configured, and to which client hosts will be connected.
<br><br>
The script should do everything automatically.
However, for the first time, I suggest you read the script (it contains
important comments) and execute commands manually.<br>
</p>
<h2>Net::LDAP::FilterMatch fix</h2>
<p>
Net::LDAP's FilterMatch module contains a bug that you have to patch manually, at least until it is
fixed in the official distribution (track bug progress report
<a href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=540938">here</a>).
</p>
<p>
The patch is simple, and included in Viper distribution as file
<i>support/FilterMatch.pm.patch</i>. Apply it with:
</p>
<pre>
patch -p0 &lt; support/FilterMatch.pm.patch
</pre>
And then re-start slapd with <b>LD_PRELOAD=/usr/lib/libperl.so.5.10 invoke-rc.d slapd restart
</b>.
</p>
<h2>Apache setup</h2>
<p>
For client hosts to be able to retrieve the preseed file, the
preseed CGI needs to be linked to the cgi-bin directory. This step
was already done by the setup script.
</p>
<p>
So, the client hosts can reach the preseed file if you specify
it with the full path, i.e. url=http://10.0.1.1/cgi-bin/preseed.cfg.
</p>
<p>
However, when only the server (without the path) is specified, debian
installer will look for file /d-i/RELEASE-NAME/preseed.cfg.
This may save you some typing when starting the installations, and if
you want to have this "shortcut", the necessary configuration should be
added manually to /etc/apache2/sites-available/default:
</p>
<pre>
ScriptAlias /d-i/squeeze/ /usr/lib/cgi-bin/
ScriptAlias /d-i/lenny/ /usr/lib/cgi-bin/
</pre>
<p>
(Then reload apache with <i>/etc/init.d/apache2 reload</i>.)
</p>
<h2>Gatewaying</h2>
<p>
Client hosts need to have access to the Internet to download
the packages etc.
</p>
<p>
In the default configuration, clients use Viper's host for
NAT/IP forwarding (i.e. attribute 'router' in <i>ldifs/c1.com.ldif</i>).
</p>
<p>
To make that work, you need to <b>apt-get install ipmasq</b> on the Viper host.
Note that it's the *host*, so even if you installed Viper in OpenVZ container,
you still run this command on the physical host.
</p>
<p>
As said, for client c1.com, DHCP will configure hosts to use
router 10.0.1.1 (which is the IP of the Viper install server for that
subnet). This will work if you're running Viper outside of OpenVZ.
</p>
<p>
If you're running Viper as a container under OpenVZ, you cannot use 10.0.1.1
as the router, because the container can't do forwarding (the 'nat' table only
exists on the physical host).
The physical host is configured to have eth1 at address 10.0.1.254, so
you need to edit <i>ldifs/c1.com.ldif</i>, search for "router: "
and change the value from 10.0.1.1 to 10.0.1.254, telling the hosts
to use Viper's physical host for forwarding.
Remember to run 'make' in the ldifs/ directory to apply the change by
reloading all data to LDAP.
</p>
<p>
NOTE: when using Viper in the OpenVZ container, starting ipmasq on the physical
host will, as explained, do the right thing for the client hosts, but will
prevent the container from accessing the Internet. This is acceptable
in the short term, because the container doesn't have to go online to
operate normally, but it's surely a suboptimal solution.<br>
I expect the issue is in ipmasq which does not detect and handle
the bridging setup properly, and so a couple rules need to be inserted
to iptables manually, to allow this traffic. I yet have to figure out
the exact lines.
</p>
<h2>Testing</h2>
<p>
After installation, you will get a working setup populated with default
data. This includes a client with name "c1.com", and three hosts, h1,
h2 and h3.<br>
<br>
Based on the default data, there are tests you can run:<br>
<h3>Testing with ldapsearch</h3>
<pre>
ldapsearch -x -b ou=dhcp
ldapsearch -x -b ou=defaults
ldapsearch -x -b ou=clients

ldapsearch -x -b cn=h2,ou=hosts,o=c1.com,ou=clients

ldapsearch -x -b cn=popularity-contest/participate,ou=hosts,ou=defaults
ldapsearch -x -b cn=debian-installer/locale,cn=h2,ou=hosts,o=c1.com,ou=clients
ldapsearch -x -b cn=ntp/servers,cn=h2,ou=hosts,o=c1.com,ou=clients
</pre>
<h4>ldapsearch test results</h4>
<p>
Ldapsearch query for <i>cn=h2,ou=hosts,o=c1.com,ou=clients</i> is a pretty good
way of determining if everything is working alright. Here's how the output
from the command should look like:
<pre>
$ ldapsearch -x -b cn=h2,ou=hosts,o=c1.com,ou=clients

# extended LDIF
#
# LDAPv3
# base <cn=h2,ou=hosts,o=c1.com,ou=clients> with scope subtree
# filter: (objectclass=*)
# requesting: ALL
#

# h2, hosts, c1.com, clients
dn: cn=h2,ou=hosts,o=c1.com,ou=clients
objectClass: top
objectClass: device
objectClass: dhcpHost
objectClass: ipHost
objectClass: ieee802Device
objectClass: puppetClient
cn: h2
ipHostNumber: 10.0.1.8
macAddress: 00:11:6b:34:ae:8d
puppetclass: test
puppetclass: ntp::server
dhcpHWAddress: ethernet 00:11:6b:34:ae:8d
dhcpOption: host-name "h2"
dhcpOption: routers 10.0.1.1
dhcpOption: domain-name-servers 192.168.1.254
dhcpOption: nis-domain "c1.com"
dhcpOption: domain-name "c1.com"
dhcpOption: subnet-mask 255.255.255.0
dhcpOption: broadcast-address 10.0.1.255
dhcpStatements: fixed-address 10.0.1.8
hostName: h2
ipNetmaskNumber: 255.255.255.0
clientName: c1.com
ipNetworkNumber: 10.0.1.0
ipBroadcastNumber: 10.0.1.255
domainName: c1.com

# search result
search: 2
result: 0 Success

# numResponses: 2
# numEntries: 1</pre>
</p>
<h3>Testing with scripts/node_data</h3>
<p>
perl scripts/node_data h2.c1.com<br>
</p>
<h3>Testing with scripts/preseed</h3>
<p>
QUERY_STRING=ip=10.0.1.8 perl scripts/preseed<br>
</p>
</p>
<h3>Testing with HTTP client</h3>
<p>
wget http://10.0.1.1/cgi-bin/preseed.cfg?ip=10.0.1.8 -O /tmp/preseed.cfg<br>
</p>
<h2>Changing the configuration / adding new clients</h2>
<p>
See <a href="client.html">Adding clients and hosts</a>.
</p>
				  <div class="clear-flat"></div>
				</div>
				<div class="clear"></div>
			</div>
		</div>
	</div>
	<div id="footer">
	<p style="text-align: right;">
	<a href="http://www.thewml.org/">
<img src="images/wml.png" alt="" width="71" height="30"></a>&nbsp;&nbsp;&nbsp;
	<a href="http://www.hcoop.net/">
<img src="images/hcbadge3.gif" alt="" width="88" height="31"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	</p>
	</div>
</div>
</body>
</html>
